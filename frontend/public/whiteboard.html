<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Flowchart Generator (Final)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #f4f4f9; color: #333; }
        h1 { color: #4a4a4a; }
        #controls { display: flex; gap: 10px; margin-bottom: 20px; width: 60%; max-width: 600px; }
        #prompt-input { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        #generate-btn { padding: 12px 24px; border: none; border-radius: 8px; background-color: #007aff; color: white; font-size: 16px; cursor: pointer; transition: background-color 0.2s; }
        #generate-btn:hover { background-color: #0056b3; }
        #generate-btn:disabled { background-color: #999; cursor: not-allowed; }
        #diagram-container { width: 90%; max-width: 1000px; border: 1px solid #ddd; border-radius: 8px; padding: 20px; min-height: 400px; background-color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .error-message { color: #d93025; font-weight: bold; white-space: pre-wrap; text-align: left; }
    </style>
</head>
<body>

    <h1>AI Flowchart Generator</h1>
    <p>Powered by Ollama in Google Colab</p>

    <div id="controls">
        <input type="text" id="prompt-input" placeholder="e.g., 'A simple login process'">
        <button id="generate-btn">Generate</button>
    </div>

    <div id="diagram-container">
        <div id="mermaid-output"> <!-- Mermaid class will be added dynamically -->
             <!-- The flowchart will appear here -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });

        document.getElementById('generate-btn').addEventListener('click', async () => {
            const prompt = document.getElementById('prompt-input').value;
            const outputDiv = document.getElementById('mermaid-output');
            const button = document.getElementById('generate-btn');

            if (!prompt) {
                alert('Please enter a process.');
                return;
            }

            outputDiv.innerText = 'Generating...';
            button.disabled = true;
            outputDiv.classList.remove('error-message'); // Clear previous errors

            try {
                // IMPORTANT: Replace this with your current ngrok URL from Colab
                const backendUrl = 'https://fde71dd22933.ngrok-free.app/generate';

                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt }),
                });

                if (!response.ok) throw new Error(`Network Error: Could not connect to the server. Status: ${response.status}`);

                const data = await response.json();
                let mermaidCode = data.mermaid_code;
                const cleanedCode = mermaidCode.replace(/``````/g, "").trim();

                if (!cleanedCode.startsWith('graph') && !cleanedCode.startsWith('flowchart')) {
                    throw new Error("The AI returned content that is not a valid diagram. Please try a more descriptive prompt.");
                }

                try {
                    outputDiv.textContent = cleanedCode;
                    outputDiv.classList.add('mermaid');
                    outputDiv.removeAttribute('data-processed');
                    await mermaid.run({ nodes: [outputDiv] });
                } catch (renderError) {
                    throw new Error(renderError.message);
                }

            } catch (error) {
                console.error('Error:', error);
                outputDiv.classList.remove('mermaid');
                outputDiv.classList.add('error-message');
                outputDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
            } finally {
                button.disabled = false;
            }
        });
    </script>
</body>
</html>
